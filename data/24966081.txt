Item(by='jmgao', descendants=None, kids=[24967880, 24966869, 24966150], score=None, time=1604308597, title=None, item_type='comment', url=None, parent=24964966, text='This doesn&#x27;t list the biggest gotcha of all, the fact that the cmsg API is incredibly sharp and there are at least 7 ways you can screw it up. Nearly every single use of cmsg in Android&#x27;s source tree was buggy in at least one of these ways:<p><pre><code>  - not aligning the cmsg buffer\n  - leaking fds if more fds are received than expected\n  - blindly dereferencing CMSG_DATA without checking the header\n  - using CMSG_SPACE(fd_count) instead of CMSG_SPACE(fd_count * sizeof(int))\n  - using CMSG_SPACE instead of CMSG_LEN for .cmsg_len\n  - using CMSG_LEN instead of CMSG_SPACE for .msg_controllen\n  - using a length specified in number of fds instead of bytes\n</code></pre>\nIt&#x27;s possible that Android is uniquely bad at this, but I&#x27;m skeptical.')