Item(by='spijdar', descendants=None, kids=[25236232, 25236488, 25236626, 25236322, 25238545], score=None, time=1606543096, title=None, item_type='comment', url=None, parent=25234693, text='To add to this:<p>The POWER7 through POWER9 processors from IBM implement an equivalent to this called &quot;SAO&quot;, or &quot;Strong Access Ordering Mode&quot;. To quote an IBM engineer:<p><pre><code>  &gt; Currently, power has a weaker memory model than x86. Implementing a stronger memory model allows an emulator to more efficiently translate x86 code into power code, resulting in faster code execution.\n</code></pre>\nWhat&#x27;s interesting is IBM publishes pretty detailed manuals about their processors. You can take a look at the POWER9 CPU manual [0] and search for &quot;SAO&quot;.<p>You&#x27;ll see just how deep down support for this mode goes. To implement this sort of strong memory ordering requires modifications e.g. SAO mode introduces a new pipeline hazard to the L2 cache and requires deep support in the MMU, including corner cases like the virtual memory for VMs and nested VMs.<p>It&#x27;s not a casual addition to the uarch.<p>EDIT:<p>It just occurred to me Apple has taken a very different approach to solving this problem.<p>From what I can tell, TSO on apple&#x27;s CPUs is just process state implemented in their &quot;high performance&quot; cores that you get from flipping a bit in the MSR register (?).<p>IBM&#x27;s version is implemented in the memory system, and is applied to pages of memory (on Linux you call mprotect to mark a page SAO). TSO-semantics are then applied regardless of which core on a potentially multiprocessor, SMP system accesses it.<p>The Apple implementation seems to be more limited -- but in a totally inconsequential way (can&#x27;t share data between TSO and non-TSO processes). But it does beg the question, what happens when you have shared memory between a Rosetta 2 process and native ARM code? If the ARM code is running on a core without TSO, what gremlins come out to eat your data?<p>[0] <a href="https:&#x2F;&#x2F;www.setphaserstostun.org&#x2F;power9&#x2F;POWER9_um_OpenPOWER_v20GA_09APR2018_pub.pdf" rel="nofollow">https:&#x2F;&#x2F;www.setphaserstostun.org&#x2F;power9&#x2F;POWER9_um_OpenPOWER_...</a>')