Item(by='DudeInBasement', descendants=None, kids=[25419651], score=None, time=1607961152, title=None, item_type='comment', url=None, parent=25417211, text='Just use some macros, easy peasy.  (gcc computed goto)<p><pre><code>    #define DEFER_START(scope_name) void * scope_name = &amp;&amp;scope_name##_end;\n    #define DEFER(scope_name, iter_name, func) void * iter_name = scope_name; { \\\n            scope_name = &amp;&amp;iter_name ##_exe; \\\n            if (0) { iter_name##_exe: {func} goto *iter_name; } }\n\n    #define DEFER_END(scope_name) scope_name##_start: goto *scope_name; scope_name##_end: {}\n    #define DEFER_EXE(scope_name) goto scope_name##_start;\n\n    ...\n    {\n    DEFER_START(scope);\n    void * p = malloc(4);\n    if (!p) DEFER_EXE(scope);\n    DEFER(scope, free_p, { printf(&quot;freep\\n&quot;); free(p); });\n    void * q = malloc(40);\n    if (!q) DEFER_EXE(scope);\n    DEFER(scope, free_q, { printf(&quot;freeq\\n&quot;); free(q); });\n    DEFER_END(scope);\n    }\n</code></pre>\nyou can even macro the free_p&#x2F; free_q names with line numbers to shorten the macros, IE DEFER(scope, {});')