Item(by='pavehawk2007', descendants=None, kids=[25270183], score=None, time=1606848791, title=None, item_type='comment', url=None, parent=25268148, text='Here&#x27;s the specification&#x27;s recommended use of SFENCE.VMA, which is just a fancier version of what I wrote above:<p>Page 66 and 67:<p>The following common situations typically require executing an SFENCE.VMA instruction:<p>1. When software recycles an ASID (i.e., reassociates it with a different page table), it should\nfirst change satp to point to the new page table using the recycled ASID, then execute\nSFENCE.VMA with rs1=x0 and rs2 set to the recycled ASID. Alternatively, software can\nexecute the same SFENCE.VMA instruction while a different ASID is loaded into satp,\nprovided the next time satp is loaded with the recycled ASID, it is simultaneously loaded\nwith the new page table.<p>2. If the implementation does not provide ASIDs, or software chooses to always use ASID 0,\nthen after every satp write, software should execute SFENCE.VMA with rs1=x0. In the\ncommon case that no global translations have been modified, rs2 should be set to a register\nother than x0 but which contains the value zero, so that global translations are not flushed.<p>3. If software modifies a non-leaf PTE, it should execute SFENCE.VMA with rs1=x0. If any\nPTE along the traversal path had its G bit set, rs2 must be x0; otherwise, rs2 should be set\nto the ASID for which the translation is being modified.<p>4. If software modifies a leaf PTE, it should execute SFENCE.VMA with rs1 set to a virtual\naddress within the page. If any PTE along the traversal path had its G bit set, rs2 must\nbe x0; otherwise, rs2 should be set to the ASID for which the translation is being modified.<p>5. For the special cases of increasing the permissions on a leaf PTE and changing an invalid\nPTE to a valid leaf, software may choose to execute the SFENCE.VMA lazily. After\nmodifying the PTE but before executing SFENCE.VMA, either the new or old permissions\nwill be used. In the latter case, a page fault exception might occur, at which point software\nshould execute SFENCE.VMA in accordance with the previous bullet point.')