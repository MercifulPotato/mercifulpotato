Item(by='malisper', descendants=None, kids=[24759982, 24763780, 24759753, 24759814, 24760395, 24760723, 24760362, 24759759, 24759783, 24763615, 24759760], score=None, time=1602538308, title=None, item_type='comment', url=None, parent=24757333, text='For those unaware, Zheap is a new storage engine for Postgres that handles updates and deletes in a different way. Currently, when you update a row in Postgres, Postgres creates a new copy of the row and marks the old one as deleted. This is done for several reasons, specifically it makes handling concurrency easier and it makes rolling back transactions easier.<p>The issue with this approach is over time this leads to lots of &quot;dead rows&quot; - deleted rows that are taking up space in your DB. Postgres has a background job called the &quot;vacuum&quot; which effectively garbage collects all deleted rows. Depending on your settings, the vacuum can be a pretty expensive job and even with the vacuum, you can still wind up using a lot more space than you actually need.<p>Zheap addresses these problems by using a different approach. When performing an update, instead of marking the old row as deleted and inserting a new one, Postgres will replace the old row with the new one and write a copy of the old row to a separate file. This means the main table file doesn&#x27;t need to be larger than necessary to keep track of the dead rows.<p>Zheap does lead to lots of tricky scenarios. If for any reason you need to access the old copy of the row, you have to fetch it from the separate file. If the transaction that performed that update is rolled back, you need to replace the new version of the row with the old version of the row. This sounds straightforward, but gets really tricky really fast. For example, what happens if I have row X that takes up 1kb. I replace it with row Y that takes up 500b. I then write row Z after row Y that takes up 500b. If you want to rollback the original transaction, row X will no longer fit in its original spot because row Z is now taking up part of the space it used to occupy.')