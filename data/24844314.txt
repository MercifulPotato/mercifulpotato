Item(by='brandmeyer', descendants=None, kids=None, score=None, time=1603248381, title=None, item_type='comment', url=None, parent=24843396, text='I don&#x27;t actually think its the cache utilization, I think its TLB demand on the hardware, and address space management demand on the kernel.  The multi-threaded use-once-only case is not well-suited to mmap.<p>For example, here&#x27;s some ripgrep runs searching for &quot;mmap&quot; in the glibc source.<p>Performance counter stats for &#x27;rg -j8 --mmap munmap&#x27;:<p><pre><code>           783,429      dTLB-load-misses                                            \n            20,903      faults                                                      \n\n       0.620738806 seconds time elapsed\n\n       0.309086000 seconds user\n       1.156984000 seconds sys\n\n Performance counter stats for &#x27;rg -j4 --mmap munmap&#x27;:\n\n           543,522      dTLB-load-misses                                            \n            20,770      faults                                                      \n\n       0.210009979 seconds time elapsed\n\n       0.222609000 seconds user\n       0.390542000 seconds sys\n\n Performance counter stats for &#x27;rg -j2 --mmap munmap&#x27;:\n\n           318,628      dTLB-load-misses                                            \n            20,736      faults                                                      \n\n       0.204980322 seconds time elapsed\n\n       0.162815000 seconds user\n       0.206498000 seconds sys\n\n Performance counter stats for &#x27;rg -j8 --no-mmap munmap&#x27;:\n\n           408,259      dTLB-load-misses                                            \n               955      faults                                                      \n\n       0.064994749 seconds time elapsed\n\n       0.224760000 seconds user\n       0.185328000 seconds sys\n\n</code></pre>\nNote that even though the total work is the same, the number of TLB misses decreases with decreasing parallelism.  There are far more &quot;faults&quot; recorded for all of the first-page-touches performed.  Linux does have fault-around, but that only reduces the number of faults; it doesn&#x27;t elide them entirely.<p><i>Addendum:</i> Additionally, the number of context switches grows super-linearly with increasing parallelism, but only with the `--mmap` flag.  A followup on the linux kernel source showed 1600 switches at j2, 8400 at j4 and 52,000 at j8 for the same search on the same sources.  With `--no-mmap` the number of context switches grows linearly from j2 through j8.<p>When I first ran into that result, another fellow repiled that he reduced some of the gap in ripgrep by eliding ripgrep&#x27;s munmap.  Some of the TLB invalidation work can be saved by just holding onto the address space for longer.')