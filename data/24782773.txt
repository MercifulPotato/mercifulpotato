Item(by='mitchellh', descendants=None, kids=[24783127], score=None, time=1602716852, title=None, item_type='comment', url=None, parent=24782623, text='Yeah this isn&#x27;t very easy to get right at the moment so there is not going to be any silver bullet here. We had to iterate on our runner a lot to get this right, but we have a lot of experience since we do this for Terraform Cloud too.<p>Answering your questions:<p>&gt; * I assume you aren&#x27;t shelling out :). Do you have any additional helper libraries on top of the Terraform code base to make it more of a a programmatically consumable API, as apposed to an end user application?<p>We in fact are. There are lots of security concerns you have to consider with this. We published a library to make this easier: <a href="https:&#x2F;&#x2F;github.com&#x2F;hashicorp&#x2F;terraform-exec" rel="nofollow">https:&#x2F;&#x2F;github.com&#x2F;hashicorp&#x2F;terraform-exec</a><p>&gt; * Are you still pointing at a directory with resources defined in HCL, or are the resources defined programmatically?<p>HCL mixed with the JSON flavor of HCL for programmatically generated stuff. Variables in JSON format also programmatically generated.<p>&gt; * What are you using for state storage?<p>We output it to a file and handle this in an HCP microservice. We encrypt it using the customer-specific key with Vault and store it in a bucket that only the customer-specific credential has access to. If there is an RCE exploit somehow in our workflows, they can only access that customer&#x27;s metadata.<p>&gt; * What is the execution environment for the programmatic Terraform process? Since Terraform uses external processes for plugins, I&#x27;ve hit some issues with resource constraints around the max number of process sysctl&#x27;s in containerized environment where I have multiple Terraform processes running in the same container.<p>Containers in HCP and VMs in Terraform Cloud due to increased isolation requirements. HCP has less strict requirements because the Terraform configs and inputs are more tightly controlled.')